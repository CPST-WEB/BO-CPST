<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bureau d'Ordre — Gestion du Courrier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card {
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      padding: 16px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: .55rem 1.1rem;
      font-weight: 600;
      cursor: pointer;
      font-size: .9rem;
      background: #ffffff;
      transition: all .15s ease;
      white-space: nowrap;
    }
    .btn:hover {
      box-shadow: 0 4px 10px rgba(148, 163, 253, 0.25);
      transform: translateY(-1px);
    }
    .btn-primary {
      background: #1d4ed8;
      color: #ffffff;
      border-color: #1d4ed8;
    }
    .btn-ghost {
      background: #f8fafc;
    }
    .btn-toggle {
      min-width: 11rem;
      justify-content: center;
      border-width: 2px;
    }
    .btn-active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }
    .btn-inactive {
      background: #ffffff;
      color: #1f2937;
      border-color: #bfdbfe;
    }
    .input {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: .55rem .8rem;
      font-size: .9rem;
      background: #ffffff;
    }
    .input-lg {
      padding: .8rem .9rem;
      font-size: .95rem;
    }
    .label {
      font-size: .72rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .tbl-th {
      text-align: left;
      font-size: .7rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      padding: .35rem .45rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .tbl-td {
      font-size: .82rem;
      color: #111827;
      padding: .4rem .45rem;
      vertical-align: top;
    }
    @media print {
      .no-print { display: none !important; }
      body { background: #ffffff; }
      .card { box-shadow: none; }
      header { position: static !important; }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<div class="max-w-7xl mx-auto px-4 py-6 space-y-4">

  <!-- ENTÊTE -->
  <header class="no-print sticky top-0 z-20 bg-white/95 backdrop-blur border border-slate-200 rounded-2xl mb-4 shadow-sm">
    <div class="px-5 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">

      <!-- Logo + titre -->
      <div class="flex items-center gap-3">
        <img src="logo%20CPST.png"
             alt="Conseil Préfectoral Skhirate Témara"
             class="h-12 w-auto object-contain rounded-md bg-white" />
        <div>
          <div class="text-xs text-slate-500">
            Conseil Préfectoral Skhirate Témara
          </div>
          <div class="text-lg md:text-xl font-bold text-slate-900">
            Bureau d'Ordre — Gestion du Courrier
          </div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="flex flex-wrap gap-2 justify-start md:justify-end items-center">
        <span id="userLabel" class="text-[10px] text-slate-500 mr-1 hidden"></span>
        <button class="btn btn-ghost" id="btnUser">Changer d'utilisateur</button>

        <input id="fileJson" type="file" accept=".json,application/json" class="hidden" />
        <button class="btn btn-ghost" id="btnImport">Importer JSON</button>
        <button class="btn btn-ghost" id="btnExportPDF">Exporter PDF</button>
        <button class="btn btn-primary" id="btnNew">Nouveau courrier</button>
      </div>
    </div>
  </header>

  <!-- FILTRES -->
  <section class="card no-print">
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <div class="md:col-span-3">
        <div class="label">Recherche</div>
        <input id="search" class="input" placeholder="Objet, n°, expéditeur, destinataire, référence…" />
      </div>
      <div class="md:col-span-2">
        <div class="label">Type</div>
        <select id="filterType" class="input">
          <option value="">Tous</option>
          <option value="entrant">Entrant</option>
          <option value="sortant">Sortant</option>
        </select>
      </div>
      <div class="md:col-span-1 text-[10px] text-right text-slate-500">
        Données stockées localement dans ce navigateur (localStorage).
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="stats" class="grid grid-cols-2 md:grid-cols-6 gap-3 no-print"></section>

  <!-- TABLEAU -->
  <section class="card">
    <table class="min-w-full" id="tbl">
      <thead>
      <tr>
        <th class="tbl-th">Type</th>
        <th class="tbl-th">N°</th>
        <th class="tbl-th">Date</th>
        <th class="tbl-th">Expéditeur / Destinataire</th>
        <th class="tbl-th">Objet</th>
        <th class="tbl-th">Service</th>
        <th class="tbl-th">Priorité</th>
        <th class="tbl-th">Échéance</th>
        <th class="tbl-th">Statut</th>
        <th class="tbl-th no-print">Pièces</th>
        <th class="tbl-th no-print">Actions</th>
      </tr>
      </thead>
      <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
    </table>
  </section>

</div>

<script>
  // ==========================
  //   CONFIG & DONNÉES
  // ==========================
  const KEY = "bo_cpst_courrier_v1";

  // Services destinataires / expéditeurs
  const SERVICES = [
    "Secrétariat",
    "Direction des Affaires de la Présidence",
    "Direction Générale des Services",
    "Service Mutualisation Coopération et Société Civile",
    "Service Gestion des Ressources humaines et Affaires Juridiques",
    "Service Des Affaires Financières et Patrimoine",
    "Service des Affaires Techniques et Développement et des Équipements",
    "Bureau de Gestion du Parc",
    "Bureau de Gestion des Archives",
    "Bureau d'information et Numérisation"
  ];

  // Comptes internes
  const ACCOUNTS = {
    bo:      { password: "1234", canEdit: true },   // Bureau d'ordre
    consult: { password: "1234", canEdit: false }   // Consultation
  };

  let CURRENT_USER = null;
  let CAN_EDIT = false;

  function $(sel, parent){ return (parent || document).querySelector(sel); }

  let ROWS = [];
  try {
    ROWS = JSON.parse(localStorage.getItem(KEY) || "[]") || [];
  } catch(e) {
    ROWS = [];
  }

  function saveLocal() {
    localStorage.setItem(KEY, JSON.stringify(ROWS));
  }

  // ==========================
  //   GESTION ROLES / LOGIN
  // ==========================
  function applyRole() {
    const userLabel = document.getElementById("userLabel");
    CAN_EDIT = !!(CURRENT_USER && CURRENT_USER.canEdit);

    if (CURRENT_USER) {
      userLabel.textContent =
        `Connecté : ${CURRENT_USER.name} (${CAN_EDIT ? "édition" : "consultation"})`;
      userLabel.classList.remove("hidden");
    } else {
      userLabel.textContent = "";
      userLabel.classList.add("hidden");
    }

    // Boutons réservés aux éditeurs
    document.getElementById("btnNew").style.display    = CAN_EDIT ? "inline-flex" : "none";
    document.getElementById("btnImport").style.display = CAN_EDIT ? "inline-flex" : "none";

    // Export PDF reste visible pour tous
    renderAll();
  }

  function loginUser() {
    const u = prompt("Nom d'utilisateur :\n- bo\n- consult");
    if (!u) return;
    const account = ACCOUNTS[u.trim()];
    if (!account) {
      alert("Utilisateur inconnu.");
      return loginUser();
    }
    const pwd = prompt("Mot de passe :");
    if (pwd !== account.password) {
      alert("Mot de passe incorrect.");
      return loginUser();
    }
    CURRENT_USER = { name: u.trim(), canEdit: account.canEdit };
    applyRole();
  }

  // ==========================
  //   OUTILS
  // ==========================
  function dangerDate(echeance) {
    if (!echeance) return "";
    const d = new Date(echeance);
    const now = new Date();
    const diff = (d - now) / (1000 * 3600 * 24);
    if (isNaN(diff)) return "";
    if (diff < 0) return "bg-red-50";
    if (diff <= 3) return "bg-amber-50";
    return "";
  }

  // ==========================
  //   STATS
  // ==========================
  function renderStats() {
    const r = ROWS;
    const total = r.length;
    const entrants = r.filter(x => x.type === "entrant").length;
    const sortants = r.filter(x => x.type === "sortant").length;
    const enTrait = r.filter(x => x.statut === "En traitement").length;
    const urg = r.filter(x => x.priorite && x.priorite !== "Normal").length;
    const late = r.filter(x =>
      x.echeance && new Date(x.echeance) < new Date()
    ).length;

    function bloc(label, value){
      return `
        <div class="card flex flex-col gap-1">
          <div class="text-[10px] uppercase tracking-wide text-slate-500">${label}</div>
          <div class="text-2xl font-bold text-slate-900">${value}</div>
        </div>`;
    }

    $("#stats").innerHTML =
      bloc("Total", total) +
      bloc("Entrants", entrants) +
      bloc("Sortants", sortants) +
      bloc("En traitement", enTrait) +
      bloc("Urgents", urg) +
      bloc("Échéances dépassées", late);
  }

  // ==========================
  //   TABLEAU
  // ==========================
  function renderTable() {
    const tb = $("#tbody");
    const fText = ($("#search").value || "").toLowerCase();
    const fType = $("#filterType").value || "";

    let rows = ROWS.slice();

    if (fType) {
      rows = rows.filter(r => r.type === fType);
    }

    if (fText) {
      rows = rows.filter(r => {
        return (
          (r.objet || "").toLowerCase().includes(fText) ||
          (r.numero || "").toLowerCase().includes(fText) ||
          (r.expediteur || "").toLowerCase().includes(fText) ||
          (r.destinataire || "").toLowerCase().includes(fText) ||
          (r.reference || "").toLowerCase().includes(fText)
        );
      });
    }

    tb.innerHTML = "";

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 11;
      td.className = "p-8 text-center text-sm text-slate-500";
      td.textContent = "Aucun courrier pour l’instant.";
      tr.appendChild(td);
      tb.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = dangerDate(r.echeance);

      function addCell(v){
        const td = document.createElement("td");
        td.className = "tbl-td";
        td.textContent = v || "";
        tr.appendChild(td);
      }

      addCell(r.type === "entrant" ? "Entrant" : "Sortant");
      addCell(r.numero || "");
      addCell(r.date || "");
      addCell(
        r.type === "entrant"
          ? (r.expediteur || "-")
          : (r.destinataire || "-")
      );
      addCell(r.objet || "");
      addCell(r.service || "");
      addCell(r.priorite || "");
      addCell(r.echeance || "-");
      addCell(r.statut || "");

      // Pièces
      const tdP = document.createElement("td");
      tdP.className = "tbl-td no-print";
      const hasPieces = r.attachments && r.attachments.length;
      if (hasPieces) {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = "Voir";
        a.className = "text-blue-600 underline";
        a.onclick = ev => { ev.preventDefault(); viewPieces(r); };
        tdP.appendChild(a);
      } else {
        tdP.textContent = "-";
        tdP.classList.add("text-slate-400");
      }
      tr.appendChild(tdP);

      // Actions
      const tdA = document.createElement("td");
      tdA.className = "tbl-td no-print";

      if (CAN_EDIT) {
        const e1 = document.createElement("a");
        e1.href = "#";
        e1.textContent = "Modifier";
        e1.className = "text-blue-600 underline mr-3";
        e1.onclick = ev => { ev.preventDefault(); openForm(r); };

        const e2 = document.createElement("a");
        e2.href = "#";
        e2.textContent = "Supprimer";
        e2.className = "text-red-600 underline";
        e2.onclick = ev => {
          ev.preventDefault();
          if (confirm("Supprimer ce courrier ?")) {
            ROWS = ROWS.filter(x => x.id !== r.id);
            saveLocal();
            renderAll();
          }
        };

        tdA.appendChild(e1);
        tdA.appendChild(e2);
      } else {
        tdA.textContent = "-";
        tdA.classList.add("text-slate-400");
      }

      tr.appendChild(tdA);
      tb.appendChild(tr);
    });
  }

  // ==========================
  //   MODAL GÉNÉRIQUE
  // ==========================
  function openModal(title, contentEl) {
    const old = document.getElementById("__modal");
    if (old) old.remove();

    const modal = document.createElement("div");
    modal.id = "__modal";
    modal.className = "fixed inset-0 z-50";

    modal.innerHTML = `
      <div class="absolute inset-0" style="background:#1f2937;opacity:.78;"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="card w-full max-w-6xl max-h-[92vh] overflow-auto bg-slate-50">
          <div class="flex items-center justify-between gap-3 mb-3">
            <h3 class="text-lg font-semibold text-slate-900">${title}</h3>
            <button class="btn btn-ghost" id="btnCloseModal">Fermer</button>
          </div>
          <div id="modalContent"></div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    const c = document.getElementById("modalContent");
    c.appendChild(contentEl);

    document.getElementById("btnCloseModal").onclick = () => modal.remove();
    modal.firstChild.onclick = () => modal.remove();
  }

  // ==========================
  //   VIEWER PIÈCES JOINTES
  // ==========================
  function viewPieces(r) {
    const wrap = document.createElement("div");

    if (r.attachments && r.attachments.length) {
      r.attachments.forEach((a, idx) => {
        const label = document.createElement("div");
        label.className = "mb-1 text-sm font-semibold text-slate-700";
        label.textContent = `${idx+1}. ${a.name || "Pièce jointe"}`;
        wrap.appendChild(label);

        const viewer = document.createElement("div");
        viewer.className =
          "mb-4 border border-slate-200 rounded-xl overflow-hidden bg-white";

        const src = a.dataUrl || a.url || "";

        if (a.mime && a.mime.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = src;
          img.className = "w-full h-auto";
          viewer.appendChild(img);
        } else if (
          a.mime === "application/pdf" ||
          (a.name || "").toLowerCase().endsWith(".pdf")
        ) {
          const emb = document.createElement("embed");
          emb.src = src;
          emb.type = "application/pdf";
          emb.style.width = "100%";
          emb.style.height = "480px";
          viewer.appendChild(emb);
        } else if (src) {
          const ifr = document.createElement("iframe");
          ifr.src = src;
          ifr.style.width = "100%";
          ifr.style.height = "420px";
          viewer.appendChild(ifr);
        } else {
          const span = document.createElement("div");
          span.className = "p-2 text-xs text-slate-500";
          span.textContent = "Pièce jointe non prévisualisable.";
          viewer.appendChild(span);
        }

        wrap.appendChild(viewer);
      });
    } else {
      const empty = document.createElement("div");
      empty.className = "text-sm text-slate-500";
      empty.textContent = "Aucune pièce jointe.";
      wrap.appendChild(empty);
    }

    openModal("Pièces jointes", wrap);
  }

  // ==========================
  //   FORMULAIRE NOUVEAU / EDIT
  // ==========================
  function openForm(initial) {
    if (!CAN_EDIT) return;

    const f = initial
      ? JSON.parse(JSON.stringify(initial))
      : {
          id: "c" + Date.now(),
          type: "entrant",
          numero: "",
          date: new Date().toISOString().slice(0,10),
          expediteur: "",
          destinataire: "",
          objet: "",
          instructions: "",
          service: SERVICES[0],
          mode: "Courrier",
          priorite: "Normal",
          echeance: "",
          statut: "Reçu",
          observation: "",
          reference: "",
          attachments: []
        };

    const grid = document.createElement("div");
    grid.className = "grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3";

    // Bandeau type
    const typeBox = document.createElement("div");
    typeBox.className =
      "lg:col-span-4 md:col-span-3 border-2 border-blue-300 bg-blue-50 p-3 rounded-xl";
    typeBox.innerHTML = `
      <div class="font-semibold text-blue-900 mb-1 text-sm">
        Type de courrier
      </div>
      <div class="flex flex-wrap gap-3">
        <button type="button" id="btnEntrant" class="btn btn-toggle">
          Entrant (Arrivée)
        </button>
        <button type="button" id="btnSortant" class="btn btn-toggle">
          Sortant (Départ)
        </button>
      </div>
    `;
    grid.appendChild(typeBox);

    // Champs principaux
    grid.innerHTML += `
      <div>
        <div class="label">N° d'enregistrement</div>
        <input id="f_numero" class="input" />
      </div>
      <div>
        <div class="label">Date</div>
        <input id="f_date" type="date" class="input" />
      </div>
      <div>
        <div class="label" id="lblPerson">Expéditeur</div>
        <input id="f_person" class="input" />
      </div>
      <div>
        <div class="label" id="lblService">Service destinataire</div>
        <select id="f_service" class="input">
          ${SERVICES.map(s => `<option>${s}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="label" id="lblMode">Mode de réception</div>
        <select id="f_mode" class="input">
          <option>Courrier</option>
          <option>Bureau d'Ordre</option>
          <option>Mail</option>
          <option>Plateforme (e-Parapheur, Majaliss...)</option>
          <option>Main propre</option>
        </select>
      </div>
      <div>
        <div class="label">Priorité</div>
        <select id="f_priorite" class="input">
          <option>Normal</option>
          <option>Urgent</option>
          <option>Très urgent</option>
        </select>
      </div>
      <div>
        <div class="label">Échéance</div>
        <input id="f_echeance" type="date" class="input" />
      </div>
      <div>
        <div class="label">Statut</div>
        <select id="f_statut" class="input">
          <option>Reçu</option>
          <option>Enregistré</option>
          <option>Distribué</option>
          <option>En traitement</option>
          <option>Répondu</option>
          <option>Clos</option>
        </select>
      </div>
      <div class="lg:col-span-4 md:col-span-3">
        <div class="label">Objet</div>
        <textarea id="f_objet" class="input input-lg" rows="3"></textarea>
      </div>
      <div class="lg:col-span-4 md:col-span-3">
        <div class="label">Instructions</div>
        <textarea id="f_instructions" class="input" rows="2"></textarea>
      </div>
      <div>
        <div class="label">Référence</div>
        <input id="f_reference" class="input" />
      </div>
      <div>
        <div class="label">Observations</div>
        <input id="f_obs" class="input" />
      </div>
      <div class="lg:col-span-4 md:col-span-3">
        <div class="label">Pièces jointes (PDF / Images)</div>
        <input id="f_files" type="file" class="input" multiple
               accept=".pdf,image/*" />
        <div id="filesList"
             class="mt-2 flex flex-wrap gap-2 text-[10px] text-slate-700"></div>
      </div>
    `;

    // Boutons bas
    const actions = document.createElement("div");
    actions.className =
      "lg:col-span-4 md:col-span-3 flex justify-end gap-2 mt-2";
    actions.innerHTML = `
      <button type="button" class="btn" id="btnCancel">Annuler</button>
      <button type="button" class="btn btn-primary" id="btnSave">
        Enregistrer
      </button>
    `;
    grid.appendChild(actions);

    // Sync form
    function renderFilesList() {
      const c = $("#filesList", grid);
      c.innerHTML = "";
      if (!f.attachments) f.attachments = [];
      f.attachments.forEach((a, idx) => {
        const span = document.createElement("span");
        span.className =
          "inline-flex items-center gap-1 border border-slate-200 px-2 py-1 rounded-full bg-white";
        span.textContent = a.name || ("Pièce " + (idx+1));
        const x = document.createElement("button");
        x.type = "button";
        x.textContent = "×";
        x.className = "text-red-500";
        x.onclick = () => {
          f.attachments.splice(idx,1);
          renderFilesList();
        };
        span.appendChild(x);
        c.appendChild(span);
      });
    }

    function syncToForm() {
      $("#f_numero",grid).value = f.numero || "";
      $("#f_date",grid).value = f.date || "";
      $("#f_objet",grid).value = f.objet || "";
      $("#f_instructions",grid).value = f.instructions || "";
      $("#f_service",grid).value = f.service || SERVICES[0];
      $("#f_mode",grid).value = f.mode || "Courrier";
      $("#f_priorite",grid).value = f.priorite || "Normal";
      $("#f_echeance",grid).value = f.echeance || "";
      $("#f_statut",grid).value = f.statut || "Reçu";
      $("#f_reference",grid).value = f.reference || "";
      $("#f_obs",grid).value = f.observation || "";

      $("#f_person",grid).value =
        (f.type === "entrant" ? f.expediteur : f.destinataire) || "";

      $("#lblPerson",grid).textContent =
        f.type === "entrant" ? "Expéditeur" : "Destinataire";
      $("#lblService",grid).textContent =
        f.type === "entrant" ? "Service destinataire" : "Service expéditeur";
      $("#lblMode",grid).textContent =
        f.type === "entrant" ? "Mode de réception" : "Mode d'envoi";

      const btnE = $("#btnEntrant",grid);
      const btnS = $("#btnSortant",grid);
      btnE.classList.remove("btn-active","btn-inactive");
      btnS.classList.remove("btn-active","btn-inactive");
      if (f.type === "entrant") {
        btnE.classList.add("btn-active");
        btnS.classList.add("btn-inactive");
      } else {
        btnS.classList.add("btn-active");
        btnE.classList.add("btn-inactive");
      }

      renderFilesList();
    }

    // Écouteurs
    grid.addEventListener("input", e => {
      const id = e.target.id;
      const v  = e.target.value;
      if (id === "f_numero") f.numero = v;
      if (id === "f_date") f.date = v;
      if (id === "f_objet") f.objet = v;
      if (id === "f_instructions") f.instructions = v;
      if (id === "f_reference") f.reference = v;
      if (id === "f_obs") f.observation = v;
      if (id === "f_person") {
        if (f.type === "entrant") f.expediteur = v;
        else f.destinataire = v;
      }
      if (id === "f_echeance") f.echeance = v;
    });

    grid.addEventListener("change", e => {
      const id = e.target.id;
      const v  = e.target.value;
      if (id === "f_service") f.service = v;
      if (id === "f_mode") f.mode = v;
      if (id === "f_priorite") f.priorite = v;
      if (id === "f_statut") f.statut = v;
    });

    // Type
    grid.addEventListener("click", e => {
      if (e.target.id === "btnEntrant") {
        f.type = "entrant";
        syncToForm();
      }
      if (e.target.id === "btnSortant") {
        f.type = "sortant";
        syncToForm();
      }
    });

    // Upload pièces
    grid.querySelector("#f_files").addEventListener("change", e => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      if (!f.attachments) f.attachments = [];

      let i = 0;
      function readNext() {
        const file = files[i++];
        if (!file) {
          renderFilesList();
          return;
        }
        const reader = new FileReader();
        reader.onload = ev => {
          f.attachments.push({
            name: file.name,
            mime: file.type,
            dataUrl: ev.target.result
          });
          readNext();
        };
        reader.readAsDataURL(file);
      }
      readNext();
      e.target.value = "";
    });

    // Boutons
    grid.querySelector("#btnCancel").onclick = () => {
      const m = document.getElementById("__modal");
      if (m) m.remove();
    };

    grid.querySelector("#btnSave").onclick = () => {
      if (!f.objet || !f.date) {
        alert("Merci de saisir au minimum la date et l'objet.");
        return;
      }
      const idx = ROWS.findIndex(x => x.id === f.id);
      if (idx >= 0) ROWS[idx] = f;
      else ROWS.unshift(f);

      saveLocal();
      const m = document.getElementById("__modal");
      if (m) m.remove();
      renderAll();
    };

    syncToForm();
    openModal(initial ? "Modifier le courrier" : "Nouveau courrier", grid);
  }

  // ==========================
  //   IMPORT JSON
  // ==========================
  function handleImportFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!Array.isArray(data)) throw new Error("Format attendu : tableau JSON.");

        const before = ROWS.length;
        const ids = {};
        ROWS.forEach(x => { ids[x.id] = true; });

        data.forEach((x, i) => {
          if (!x || typeof x !== "object") return;
          if (!x.id) x.id = "imp_" + Date.now() + "_" + i;
          if (!ids[x.id]) {
            ROWS.push(x);
            ids[x.id] = true;
          }
        });

        saveLocal();
        renderAll();
        alert("Import terminé. " + (ROWS.length - before) + " courriers ajoutés.");
      } catch (err) {
        alert("Erreur lors de l'import : " + err.message);
      }
    };
    reader.readAsText(file, "utf-8");
  }

  // ==========================
  //   BOUTONS GLOBAUX
  // ==========================
  document.getElementById("btnUser").onclick = () => loginUser();

  document.getElementById("btnNew").onclick = () => {
    if (CAN_EDIT) openForm(null);
  };

  document.getElementById("btnImport").onclick = () => {
    if (!CAN_EDIT) return;
    document.getElementById("fileJson").click();
  };

  document.getElementById("fileJson").addEventListener("change", e => {
    if (!CAN_EDIT) {
      e.target.value = "";
      return;
    }
    const f = e.target.files[0];
    if (f) handleImportFile(f);
    e.target.value = "";
  });

  document.getElementById("btnExportPDF").onclick = () => {
    window.print();
  };

  document.getElementById("search").oninput = renderAll;
  document.getElementById("filterType").onchange = renderAll;

  function renderAll() {
    renderStats();
    renderTable();
  }

  // Au chargement : demander l'utilisateur
  loginUser();
  if (!CURRENT_USER) {
    // Si l'utilisateur ferme les prompts : mode consultation anonyme
    CURRENT_USER = { name: "consult", canEdit: false };
    applyRole();
  }
</script>
</body>
</html>
