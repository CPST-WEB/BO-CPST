
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bureau d'Ordre — Import JSON + Export PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border-radius:16px;background:#fff;box-shadow:0 12px 36px rgba(0,0,0,.08);padding:16px;}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem 1.1rem;font-weight:600;cursor:pointer;}
    .btn-primary{background:#1e3a8a;color:#fff;border-color:#1e40af;}
    .btn-ghost{background:#f8fafc;}
    .btn-toggle{min-width: 11rem; justify-content:center; border-width:2px;}
    .btn-active{background:#1d4ed8; color:#fff; border-color:#1e40af;}
    .btn-inactive{background:#fff; color:#1f2937; border-color:#93c5fd;}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem 1rem;font-size:.95rem;}
    .input-lg{padding:1rem 1rem;font-size:1rem;}
    .label{font-size:.9rem;font-weight:600;color:#334155;}
    .tbl-th{ text-align:left; font-size:.75rem; font-weight:700; color:#475569; text-transform:uppercase; padding:.5rem; }
    .tbl-td{ font-size:.9rem; color:#111827; padding:.5rem; }
    @media print {
      .no-print{display:none!important}
      body{background:#fff}
      .card{box-shadow:none}
      header{position:static !important}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4">
    <header class="no-print sticky top-0 z-10 bg-white/90 backdrop-blur border rounded-lg">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-12 w-12 rounded-md border bg-blue-700"></div>
          <div>
            <div class="text-xl font-bold">Conseil Préfectoral SKHIRATE TEMARA</div>
            <div class="text-sm text-gray-600">Bureau d'Ordre — Import JSON + Export PDF</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input id="fileJson" type="file" accept=".json,application/json" class="hidden" />
          <button class="btn" id="btnImport">Importer JSON</button>
          <button class="btn" id="btnExportPDF">Exporter PDF</button>
          <button class="btn btn-primary" id="btnNew">Nouveau courrier</button>
        </div>
      </div>
    </header>

    <section class="my-4 p-3 card">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="label">Recherche</label>
          <input id="search" class="input" placeholder="Objet, n°, expéditeur, référence…">
        </div>
        <div>
          <label class="label">Filtrer par type</label>
          <select id="filterType" class="input">
            <option value="">Tous</option>
            <option value="entrant">Entrant</option>
            <option value="sortant">Sortant</option>
          </select>
        </div>
        <div class="md:col-span-3 text-right">
          <span class="text-sm text-gray-600">Données locales (démo)</span>
        </div>
      </div>
    </section>

    <section id="stats" class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4"></section>

    <section class="card">
      <table class="min-w-full" id="tbl">
        <thead>
          <tr>
            <th class="tbl-th">Type</th>
            <th class="tbl-th">N°</th>
            <th class="tbl-th">Date</th>
            <th class="tbl-th">Expéditeur / Destinataire</th>
            <th class="tbl-th">Objet</th>
            <th class="tbl-th">Service</th>
            <th class="tbl-th">Priorité</th>
            <th class="tbl-th">Échéance</th>
            <th class="tbl-th">Statut</th>
            <th class="tbl-th no-print">Pièces</th>
            <th class="tbl-th no-print">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y"></tbody>
      </table>
    </section>
  </div>

  <script>
    const $ = (s,p=document)=>p.querySelector(s);
    const KEY = "bo_demo_rows_upload_v3";
    const SERVICES = [
      "Secrétariat",
      "Direction des Affaires de la Présidence",
      "Direction Générale des Services",
      "Service Mutualisation Coopération et Société Civile",
      "Service Gestion des Ressources humaines et Affaires Juridiques",
      "Service Des Affaires Financières et Patrimoine",
      "Service des Affaires Techniques et Développement et des Équipements",
      "Bureau de Gestion du Parc",
      "Bureau de Gestion des Archives",
      "Bureau d'information et Numérisation"
    ];
    let ROWS = JSON.parse(localStorage.getItem(KEY) || "[]");
    const saveLocal = ()=>localStorage.setItem(KEY, JSON.stringify(ROWS));

    const dangerDate = (e)=>{
      if(!e) return "";
      const d = new Date(e), n = new Date();
      const diff = (d - n) / (1000*3600*24);
      if(diff < 0) return "bg-red-50";
      if(diff <= 3) return "bg-yellow-50";
      return "";
    };

    const renderStats = ()=>{
      const r = ROWS||[];
      const t = r.length;
      const e = r.filter(x=>x.type==="entrant").length;
      const s = r.filter(x=>x.type==="sortant").length;
      const enT = r.filter(x=>x.statut==="En traitement").length;
      const urg = r.filter(x=>x.priorite && x.priorite!=="Normal").length;
      const late = r.filter(x=>x.echeance && new Date(x.echeance) < new Date()).length;
      const c = (ti,v)=>`<div class="card"><div class="text-xs text-gray-500">${ti}</div><div class="text-2xl font-bold">${v}</div></div>`;
      $("#stats").innerHTML = c("Total",t)+c("Entrants",e)+c("Sortants",s)+c("En traitement",enT)+c("Urgents",urg)+c("Échéances dépassées",late);
    };

    const renderTable = ()=>{
      const r0 = (ROWS||[]).slice();
      const fText = ($("#search").value||"").toLowerCase();
      const fType = $("#filterType").value||"";
      const tb = $("#tbody");
      let rows = r0;
      if(fType) rows = rows.filter(r=>r.type===fType);
      if(fText){
        rows = rows.filter(r=>
          (r.objet||"").toLowerCase().includes(fText) ||
          (r.numero||"").toLowerCase().includes(fText) ||
          (r.expediteur||"").toLowerCase().includes(fText) ||
          (r.destinataire||"").toLowerCase().includes(fText) ||
          (r.reference||"").toLowerCase().includes(fText)
        );
      }
      tb.innerHTML = "";
      if(rows.length===0){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=11; td.className="p-8 text-center text-sm text-gray-500";
        td.textContent="Aucun courrier pour l’instant.";
        tr.appendChild(td); tb.appendChild(tr); return;
      }
      rows.forEach(r=>{
        const tr=document.createElement("tr"); tr.className = dangerDate(r.echeance);
        const cells = [
          r.type==="entrant"?"Entrant":"Sortant",
          r.numero||"",
          r.date||"",
          r.type==="entrant"?(r.expediteur||"-"):(r.destinataire||"-"),
          r.objet||"", r.service||"", r.priorite||"", r.echeance||"-", r.statut||""
        ];
        cells.forEach(v=>{ const td=document.createElement("td"); td.className="tbl-td"; td.textContent=v; tr.appendChild(td); });

        const tdP=document.createElement("td"); tdP.className="tbl-td no-print";
        const hasA = (r.attachments && r.attachments.length>0);
        tdP.appendChild(hasA ? (function(){ const a=document.createElement("a"); a.href="#"; a.className="text-blue-600 underline"; a.textContent="Voir"; a.onclick=(e)=>{e.preventDefault();viewPieces(r)}; return a; })() : (function(){const s=document.createElement("span"); s.className="text-gray-400"; s.textContent="-"; return s;})());
        tr.appendChild(tdP);

        const tdA=document.createElement("td"); tdA.className="tbl-td no-print";
        const edit=document.createElement("a"); edit.href="#"; edit.className="text-blue-600 underline mr-3"; edit.textContent="Modifier"; edit.onclick=(e)=>{e.preventDefault();openForm(r)};
        const del=document.createElement("a"); del.href="#"; del.className="text-red-600 underline"; del.textContent="Supprimer"; del.onclick=(e)=>{e.preventDefault(); if(confirm('Supprimer ?')){ ROWS = ROWS.filter(x=>x.id!==r.id); saveLocal(); renderAll(); } };
        tdA.appendChild(edit); tdA.appendChild(del); tr.appendChild(tdA);
        tb.appendChild(tr);
      });
    };

    const viewPieces = (r)=>{
      const div = document.createElement("div");
      const pills = document.createElement("div"); pills.className="flex flex-wrap gap-2 mb-3";
      (r.attachments||[]).forEach((a,idx)=>{
        const s=document.createElement("span"); s.className="inline-flex items-center gap-2 border px-2 py-1 rounded";
        const aDl = document.createElement("a"); aDl.className="text-blue-600 underline";
        aDl.textContent = a.name || ("Pièce "+(idx+1));
        if(a.url){ aDl.href=a.url; aDl.target="_blank"; }
        s.appendChild(aDl); pills.appendChild(s);
      });
      div.appendChild(pills);
      (r.attachments||[]).forEach(a=>{
        const isImg = a.mime && a.mime.startsWith("image/");
        const isPDF = a.mime==="application/pdf" || (a.name||'').toLowerCase().endsWith(".pdf");
        const wrap = document.createElement("div"); wrap.className="border rounded-lg overflow-hidden mb-3"; if(!isImg) wrap.style.height="70vh";
        if(isImg){
          const img=document.createElement("img"); img.src=a.url; img.className="w-full h-auto"; wrap.appendChild(img);
        } else if(isPDF){
          const emb=document.createElement("embed"); emb.src=a.url; emb.type="application/pdf"; emb.className="w-full h-full"; wrap.appendChild(emb);
        } else {
          const ifr=document.createElement("iframe"); ifr.src=a.url; ifr.className="w-full"; ifr.style.height="70vh"; wrap.appendChild(ifr);
        }
        div.appendChild(wrap);
      });
      openModal("Pièces jointes", div);
    };

    const openModal = (title,content)=>{
      const old = document.getElementById("__modal");
      if(old) old.remove();
      const modal=document.createElement("div"); modal.id="__modal"; modal.className="fixed inset-0 z-50";
      modal.innerHTML=`
        <div class="absolute inset-0" style="background:#1f3b82;opacity:1;"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="card w-full max-w-[90vw] transform transition duration-200 ease-out" style="background:#eaf1ff;box-shadow:0 20px 60px rgba(0,0,0,.2);opacity:1;transform:scale(0.98);">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">`+title+`</h3>
              <button class="btn btn-ghost" id="btnCloseModal">Fermer</button>
            </div>
            <div class="mt-3" id="modalContent" style="max-height:75vh; overflow:auto;"></div>
          </div>
        </div>`;
      document.body.appendChild(modal);
      document.getElementById("modalContent").appendChild(content);
      document.getElementById("btnCloseModal").onclick = ()=>modal.remove();
      setTimeout(()=>{ const p=modal.querySelector(".transform"); if(p) p.style.transform="scale(1)"; },10);
      modal.firstElementChild.onclick = ()=>modal.remove();
    };

    function openForm(initial){
      const f = Object.assign({
        id: initial?.id || String(Date.now()),
        type: initial?.type || "entrant",
        numero: initial?.numero || "",
        date: initial?.date || new Date().toISOString().slice(0,10),
        expediteur: initial?.expediteur || "",
        destinataire: initial?.destinataire || "",
        objet: initial?.objet || "",
        instructions: initial?.instructions || "",
        service: initial?.service || SERVICES[0],
        mode: initial?.mode || "Bureau d'Ordre",
        priorite: initial?.priorite || "Normal",
        echeance: initial?.echeance || "",
        statut: initial?.statut || "Reçu",
        observation: initial?.observation || "",
        reference: initial?.reference || "",
        attachments: initial?.attachments || []
      });

      const form = document.createElement("form");
      form.onsubmit = (e)=>{ e.preventDefault();
        const idx = ROWS.findIndex(x=>x.id===f.id);
        if(idx>=0) ROWS[idx]=f; else ROWS.unshift(f);
        saveLocal(); document.getElementById("__modal")?.remove(); renderAll();
      };

      const grid = document.createElement("div");
      grid.className = "grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3";

      const typeSection = document.createElement("div");
      typeSection.className = "lg:col-span-4 md:col-span-3 border-2 border-blue-300 bg-blue-50 p-3 rounded-lg";
      typeSection.innerHTML = `
        <div class="font-semibold text-blue-800 mb-2">Type de courrier (choisissez une seule option)</div>
        <div class="flex flex-wrap gap-3">
          <button type="button" id="btnEntrant" class="btn btn-toggle btn-inactive">Entrant (Arrivée)</button>
          <button type="button" id="btnSortant" class="btn btn-toggle btn-inactive">Sortant (Départ)</button>
        </div>`;
      grid.appendChild(typeSection);

      const b1 = document.createElement("div"); b1.innerHTML = `<div class="label">N° d'enregistrement</div><input class="input" id="f_numero" placeholder="Ex: 23/2025">`;
      const b2 = document.createElement("div"); b2.innerHTML = `<div class="label">Date</div><input type="date" class="input" id="f_date">`;
      const b3 = document.createElement("div"); b3.innerHTML = `<div class="label" id="lblPerson">Expéditeur</div><input class="input" id="f_person" placeholder="Personne / Organisme">`;
      const b4 = document.createElement("div"); b4.innerHTML = `<div class="label" id="lblService">Service destinataire</div>
        <select class="input" id="f_service">${SERVICES.map(s=>`<option>${s}</option>`).join("")}</select>`;
      grid.appendChild(b1); grid.appendChild(b2); grid.appendChild(b3); grid.appendChild(b4);

      const b5 = document.createElement("div"); b5.innerHTML = `<div class="label" id="lblMode">Mode de réception</div>
        <select class="input" id="f_mode"><option>Courrier</option><option>Bureau d'Ordre</option><option>Mail</option><option>Plateforme (e-Parapheur, Majaliss...)</option><option>Main propre</option></select>`;
      const b6 = document.createElement("div"); b6.innerHTML = `<div class="label">Priorité</div>
        <select class="input" id="f_priorite"><option>Normal</option><option>Urgent</option><option>Très urgent</option></select>`;
      const b7 = document.createElement("div"); b7.innerHTML = `<div class="label">Échéance</div><input type="date" class="input" id="f_echeance">`;
      const b8 = document.createElement("div"); b8.innerHTML = `<div class="label">Statut</div>
        <select class="input" id="f_statut"><option>Reçu</option><option>Enregistré</option><option>Distribué</option><option>En traitement</option><option>Répondu</option><option>Clos</option></select>`;
      grid.appendChild(b5); grid.appendChild(b6); grid.appendChild(b7); grid.appendChild(b8);

      const b9 = document.createElement("div"); b9.className="lg:col-span-4 md:col-span-3"; b9.innerHTML = `<div class="label">Objet</div><textarea class="input input-lg" rows="3" id="f_objet" placeholder="Objet du courrier (détaillé)…"></textarea>`;
      const b10 = document.createElement("div"); b10.className="lg:col-span-4 md:col-span-3"; b10.innerHTML = `<div class="label">Instructions</div><textarea class="input" rows="3" id="f_instructions" placeholder="Instructions / suites à donner…"></textarea>`;
      grid.appendChild(b9); grid.appendChild(b10);

      const b11 = document.createElement("div"); b11.innerHTML = `<div class="label">Référence</div><input class="input" id="f_reference" placeholder="Référence (externe/interne)">`;
      const b12 = document.createElement("div"); b12.innerHTML = `<div class="label">Observations</div><input class="input" id="f_obs" placeholder="Observations">`;
      const b13 = document.createElement("div"); b13.className="lg:col-span-4 md:col-span-3"; b13.innerHTML = `<div class="label">Pièces jointes (PDF/JPG/PNG)</div>
        <input type="file" id="f_files" class="input" accept=".pdf,image/*" multiple>
        <div id="filesList" class="mt-2 flex flex-wrap gap-2"></div>`;
      grid.appendChild(b11); grid.appendChild(b12); grid.appendChild(b13);

      const actionsWrap = document.createElement("div");
      actionsWrap.className = "sticky bottom-0 mt-3 bg-[#eaf1ff] py-3 border-t lg:col-span-4 md:col-span-3 flex justify-end gap-2";
      actionsWrap.innerHTML = `<button type="button" class="btn" id="btnCancel">Annuler</button><button type="submit" class="btn btn-primary">`+(initial?"Enregistrer les modifications":"Enregistrer")+`</button>`;

      const container = document.createElement("div");
      container.appendChild(grid);
      container.appendChild(actionsWrap);

      const refreshFilesList = ()=>{
        const c = grid.querySelector("#filesList"); c.innerHTML="";
        (f.attachments||[]).forEach((a,idx)=>{
          const s=document.createElement("span"); s.className="inline-flex items-center gap-2 border px-2 py-1 rounded";
          const aDl = document.createElement("a"); aDl.className="text-blue-600 underline"; aDl.textContent=a.name||("Pièce "+(idx+1));
          if(a.url){ aDl.href=a.url; aDl.target="_blank"; }
          const rm = document.createElement("button"); rm.type="button"; rm.textContent="×"; rm.onclick=()=>{ f.attachments.splice(idx,1); refreshFilesList(); };
          s.appendChild(aDl); s.appendChild(rm); c.appendChild(s);
        });
      };

      const sync = ()=>{
        $("#f_numero").value = f.numero;
        $("#f_date").value = f.date;
        $("#f_person").value = (f.type==="entrant"? f.expediteur : f.destinataire);
        $("#f_objet").value = f.objet||"";
        $("#f_instructions").value = f.instructions||"";
        $("#f_service").value = f.service;
        $("#f_mode").value = f.mode;
        $("#f_priorite").value = f.priorite;
        $("#f_echeance").value = f.echeance||"";
        $("#f_statut").value = f.statut;
        $("#f_reference").value = f.reference||"";
        $("#f_obs").value = f.observation||"";
        $("#lblPerson").textContent = (f.type==="entrant"?"Expéditeur":"Destinataire");
        $("#lblService").textContent = (f.type==="entrant"?"Service destinataire":"Service expéditeur");
        $("#lblMode").textContent = (f.type==="entrant"?"Mode de réception":"Mode d'envoi");
        const btnE = document.getElementById('btnEntrant');
        const btnS = document.getElementById('btnSortant');
        if (btnE && btnS) {
          btnE.classList.remove('btn-active','btn-inactive');
          btnS.classList.remove('btn-active','btn-inactive');
          if (f.type==='entrant'){ btnE.classList.add('btn-active'); btnS.classList.add('btn-inactive'); }
          else { btnS.classList.add('btn-active'); btnE.classList.add('btn-inactive'); }
        }
        refreshFilesList();
      };

      grid.addEventListener('input', (e)=>{
        const id=e.target.id, val=e.target.value;
        if(id==="f_numero") f.numero=val;
        if(id==="f_date") f.date=val;
        if(id==="f_person"){ if(f.type==="entrant") f.expediteur=val; else f.destinataire=val; }
        if(id==="f_objet") f.objet=val;
        if(id==="f_instructions") f.instructions=val;
        if(id==="f_echeance") f.echeance=val;
        if(id==="f_reference") f.reference=val;
        if(id==="f_obs") f.observation=val;
      });
      grid.addEventListener('change',(e)=>{
        const id=e.target.id, val=e.target.value;
        if(id==="f_service") f.service=val;
        if(id==="f_mode") f.mode=val;
        if(id==="f_priorite") f.priorite=val;
        if(id==="f_statut") f.statut=val;
      });

      setTimeout(()=>{
        const btnE = document.getElementById('btnEntrant');
        const btnS = document.getElementById('btnSortant');
        function updateButtons(){
          if (f.type === 'entrant') {
            btnE.classList.add('btn-active'); btnE.classList.remove('btn-inactive');
            btnS.classList.add('btn-inactive'); btnS.classList.remove('btn-active');
          } else {
            btnS.classList.add('btn-active'); btnS.classList.remove('btn-inactive');
            btnE.classList.add('btn-inactive'); btnE.classList.remove('btn-active');
          }
          sync();
        }
        btnE.onclick = ()=>{ f.type='entrant'; updateButtons(); };
        btnS.onclick = ()=>{ f.type='sortant'; updateButtons(); };
        updateButtons();
      },0);

      grid.querySelector("#f_files").addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files||[]);
        for(const file of files){
          const url = URL.createObjectURL(file);
          f.attachments = f.attachments || [];
          f.attachments.push({ name:file.name, mime:file.type, url });
        }
        refreshFilesList();
        e.target.value = "";
      });

      openModal(initial?"Modifier le courrier":"Nouveau courrier", container);
      document.getElementById("btnCancel").onclick = ()=>document.getElementById("__modal")?.remove();
      sync();
    }

    function handleImportFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!Array.isArray(data)) throw new Error("Le JSON doit être un tableau d'objets.");
          const before = ROWS.length;
          const ids = new Set(ROWS.map(x=>x.id));
          data.forEach(x=>{ if(x && !ids.has(x.id)){ ROWS.push(x); ids.add(x.id); } });
          saveLocal();
          renderAll();
          alert("Import terminé : " + (ROWS.length - before) + " lignes ajoutées");
        }catch(e){
          alert("Erreur JSON : " + e.message);
        }
      };
      reader.readAsText(file, "utf-8");
    }

    document.getElementById("btnImport").onclick = ()=> document.getElementById("fileJson").click();
    document.getElementById("fileJson").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) handleImportFile(f);
      e.target.value = "";
    });

    document.getElementById("btnExportPDF").onclick = ()=> window.print();

    const renderAll = ()=>{ renderStats(); renderTable(); };
    document.getElementById("btnNew").onclick = ()=>openForm(null);
    document.getElementById("search").oninput = renderAll;
    document.getElementById("filterType").onchange = renderAll;

    renderAll();
  </script>
</body>
</html>
